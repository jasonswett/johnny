#!/usr/bin/env ruby

require File.expand_path('../../config/environment', __FILE__)

def with_token(value, &block)
  token = Token.find_by(value: value)

  if token.present?
    block.call(token)
  else
    puts "No such token '#{value}'. Sorry bro"
  end
end

case ARGV[0]
when "index"
  book_collection = BookCollection.new
  book_collection.index!
when "tokens"
  Token.most_frequent_first.limit(30).each do |token|
    puts "#{token.value} (#{token.annotations['frequency']})"
  end
when "token"
  with_token(ARGV[1]) do |token|
    puts token.details
  end
when "related"
  tokens = Token.where(value: ARGV[1..-1])
  puts Token.related(tokens).map(&:value).join(", ")
when "followers"
  with_token(ARGV[1]) do |token|
    puts token.followers.join(", ")
  end
when "pos"
  part_of_speech = ARGV[1]
  Token.part_of_speech(part_of_speech).limit(30).each do |token|
    puts "#{token.value} (#{token.annotations['frequency']})"
  end
when "analyze"
  words = ARGV[1..-1]
  sentence = Sentence.new(words.join(" "))
  tokens = sentence.tokens.map { |token| Token.find_by(value: token.value) || token }
  parts_of_speech = tokens.map { |token| token.annotations["part_of_speech"] || "?" }
  puts parts_of_speech.join(" ")
when "eval"
  parts_of_speech = ARGV[1..-1]
  expression_mask = ExpressionMask.new(parts_of_speech.join(" "))
  puts expression_mask.evaluate
when "label_parts_of_speech"
  PartOfSpeechAnnotation.label_parts_of_speech(Token.all)
when "sample_contexts"
  with_token(ARGV[1]) do |token|
    puts ExpressionMask.sample_contexts(token)
  end
when "generate"
  puts ARGV[2..-1].map { |value| value.upcase }.join(" AND ")
  tokens = Token.where(value: ARGV[2..-1])
  related_tokens = Token.related(tokens)

  ARGV[1].to_i.times do
    print ExpressionMask.generate_sentence(related_tokens:) + " "
  end

  puts
  puts
else
  puts "Invalid input"
end
